version: 2.1

orbs:
  python: circleci/python@0.2.1

jobs:
  build-and-test:
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run:
          name: installing dependencies
          command: sudo apt update && sudo apt install --yes --force-yes postgresql-client-common
      - run:
          name: building server image
          command: make build-server
      - run:
          name: building worker image
          command: make build-worker
      - run:
          name: starting test env
          command: docker-compose --file Dockerfiles/test-env.yml up -d
      - run:
          name: creating db user
          command: >-
            docker-compose --file Dockerfiles/test-env.yml
            exec jarr_postgresql su postgres -c
            "createuser jarr --no-superuser --createdb --no-createrole"
      - run:
          name: creating db
          command: >-
            docker-compose --file Dockerfiles/test-env.yml
            exec jarr_postgresql su postgres -c "createdb jarr --no-password"
      - run:
          name: creating tables
          command: >-
            docker-compose --file Dockerfiles/test-env.yml
            exec jarr_server bash -c
            "pipenv sync --dev --bare; pipenv run ./manager.py db_create"
      - run:
          name: testing
          command: >-
            docker-compose --file Dockerfiles/test-env.yml
            exec jarr_server bash -c
            "pipenv sync --dev --bare; pipenv run nosetests tests/ -vv --with-coverage --cover-package=jarr"

workflows:
  jarr-testing:
    jobs:
      - build-and-test
